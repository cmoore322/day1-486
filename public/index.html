<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Connor Blog SPA</title>
  <meta name="author" content="cmoore322">
  <!-- normalize + bootstrap + jquery from CDN (offline optional) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" integrity="sha512-oHDEc8Xed6v0s6B5g6z5X1sQZ3Xx6m3QfZl1xv3gY4JkI6bq3VbqQZxM5e6G7+8K" crossorigin="anonymous" referrerpolicy="no-referrer"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>body{padding:20px}</style>
</head>
<body>
  <div class="container">
    <h1 class="mb-3">Connor Blog SPA</h1>
    <p class="text-muted">Create posts and they will be stored in MongoDB. Author: <strong>cmoore322</strong></p>

    <div class="row">
      <div class="col-md-5">
        <div class="card mb-3">
          <div class="card-body">
            <h5 class="card-title">New Post</h5>
            <form id="postForm">
              <div class="mb-2">
                <input class="form-control" id="title" placeholder="Title" required>
              </div>
              <div class="mb-2">
                <textarea class="form-control" id="body" rows="5" placeholder="Write your post body" required></textarea>
              </div>
              <div class="mb-2">
                <input class="form-control" id="author" placeholder="Author (optional)">
              </div>
              <button class="btn btn-primary" id="submitPost">Publish</button>
            </form>
          </div>
        </div>

        <div id="editArea" class="card mb-3 d-none">
          <div class="card-body">
            <h5 class="card-title">Edit Post</h5>
            <form id="editForm">
              <input type="hidden" id="editId">
              <div class="mb-2"><input class="form-control" id="editTitle"></div>
              <div class="mb-2"><textarea class="form-control" id="editBody" rows="4"></textarea></div>
              <div class="mb-2"><input class="form-control" id="editAuthor"></div>
              <button class="btn btn-success" id="saveEdit">Save</button>
              <button class="btn btn-secondary" id="cancelEdit" type="button">Cancel</button>
            </form>
          </div>
        </div>

      </div>

      <div class="col-md-7">
        <h4>Posts</h4>
        <div id="postsList"></div>
      </div>
    </div>

  </div>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script>
    const api = {
      list: () => fetch('/api/posts').then(r => r.json()),
      create: (data) => fetch('/api/posts', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(data) }).then(r => r.json()),
      get: (id) => fetch(`/api/posts/${id}`).then(r => r.json()),
      update: (id, data) => fetch(`/api/posts/${id}`, { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(data) }).then(r => r.json()),
      del: (id) => fetch(`/api/posts/${id}`, { method: 'DELETE' }).then(r => r.json())
    };

    function renderPosts(posts){
      const $list = $('#postsList');
      $list.empty();
      if(!posts.length) return $list.append('<p class="text-muted">No posts yet.</p>');
      posts.forEach(p => {
        const el = $(
          `<div class="card mb-2" data-id="${p._id}">
             <div class="card-body">
               <h5 class="card-title">${escapeHtml(p.title)}</h5>
               <h6 class="card-subtitle mb-2 text-muted">by ${escapeHtml(p.author || 'Anonymous')} â€¢ ${new Date(p.createdAt).toLocaleString()}</h6>
               <p class="card-text">${escapeHtml(p.body)}</p>
               <button class="btn btn-sm btn-outline-primary edit">Edit</button>
               <button class="btn btn-sm btn-outline-danger delete">Delete</button>
             </div>
           </div>`
        );
        el.find('.edit').on('click', () => startEdit(p));
        el.find('.delete').on('click', () => doDelete(p._id));
        $list.append(el);
      });
    }

    function escapeHtml(str){
      if(!str) return '';
      return $('<div>').text(str).html();
    }

    async function refresh(){
      const posts = await api.list();
      renderPosts(posts);
    }

    async function doDelete(id){
      if(!confirm('Delete this post?')) return;
      await api.del(id);
      await refresh();
    }

    function startEdit(post){
      $('#editId').val(post._id);
      $('#editTitle').val(post.title);
      $('#editBody').val(post.body);
      $('#editAuthor').val(post.author);
      $('#editArea').removeClass('d-none');
      window.scrollTo({top:0, behavior:'smooth'});
    }

    $(function(){
      $('#postForm').on('submit', async (e) => {
        e.preventDefault();
        const data = { title: $('#title').val(), body: $('#body').val(), author: $('#author').val() };
        await api.create(data);
        $('#title').val(''); $('#body').val(''); $('#author').val('');
        await refresh();
      });

      $('#editForm').on('submit', async (e) => {
        e.preventDefault();
        const id = $('#editId').val();
        const data = { title: $('#editTitle').val(), body: $('#editBody').val(), author: $('#editAuthor').val() };
        await api.update(id, data);
        $('#editArea').addClass('d-none');
        await refresh();
      });

      $('#cancelEdit').on('click', () => { $('#editArea').addClass('d-none'); });

      refresh();
    });
  </script>
</body>
</html>